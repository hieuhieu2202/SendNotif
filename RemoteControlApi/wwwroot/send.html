<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>B·∫£ng ƒëi·ªÅu khi·ªÉn g·ª≠i th√¥ng b√°o</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
            font-family: "Inter", system-ui, sans-serif;
        }
        body {
            margin: 0;
            padding: 1.5rem;
            background: #f5f7fb;
            color: #111827;
        }
        header {
            margin-bottom: 1.5rem;
        }
        h1 {
            margin: 0 0 0.5rem;
            font-size: 2rem;
        }
        h2 {
            margin-top: 0;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: 0 12px 30px rgba(15, 32, 75, 0.1);
            margin-bottom: 1.25rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
        }
        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.55rem 0.75rem;
            font-size: 0.95rem;
            box-sizing: border-box;
        }
        textarea {
            min-height: 150px;
            resize: vertical;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.65rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
        }
        button.secondary {
            background: transparent;
            color: #1d4ed8;
            border: 1px solid #c7d2fe;
        }
        button.danger {
            background: #ef4444;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .grid {
            display: grid;
            gap: 1rem;
        }
        .grid-columns-2 {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .targets {
            display: grid;
            gap: 0.75rem;
        }
        .target-row {
            display: grid;
            gap: 0.75rem;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            align-items: end;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.75rem;
            background: #f9fafb;
        }
        .target-row button {
            justify-self: flex-start;
        }
        .status {
            font-size: 0.9rem;
            white-space: pre-wrap;
            background: #0f172a;
            color: #e0f2fe;
            padding: 1rem;
            border-radius: 8px;
            min-height: 150px;
        }
        .hint {
            font-size: 0.88rem;
            color: #4b5563;
        }
        .app-list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: grid;
            gap: 0.6rem;
        }
        .app-list li {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            background: #fefefe;
        }
        ul.version-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 0.6rem;
        }
        ul.version-list li {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            background: #f9fafb;
        }
    </style>
</head>
<body>
<header>
    <h1>G·ª≠i th√¥ng b√°o ƒëa ·ª©ng d·ª•ng</h1>
    <p class="hint">Nh·∫≠p ƒë·ªãa ch·ªâ API, t·∫°o app key n·∫øu c·∫ßn r·ªìi th√™m c√°c ·ª©ng d·ª•ng nh·∫≠n th√¥ng b√°o. B·∫°n c√≥ th·ªÉ g·∫Øn b·∫£n ph√°t h√†nh kh√°c nhau cho t·ª´ng app.</p>
</header>

<section class="card">
    <div class="grid" style="gap:0.85rem;">
        <div>
            <label for="apiBase">M√°y ch·ªß API</label>
            <input id="apiBase" type="url" placeholder="https://example.com" />
            <p class="hint">T·∫•t c·∫£ request s·∫Ω g·ª≠i t·ªõi ƒë·ªãa ch·ªâ n√†y (v√≠ d·ª• <code>https://your-host/api/control/...</code>).</p>
        </div>
        <div style="display:flex; gap:0.75rem; align-items:flex-end;">
            <button id="btnLoadApps">T·∫£i danh s√°ch ·ª©ng d·ª•ng</button>
            <button id="btnResetTargets" class="secondary">Xo√° to√†n b·ªô m·ª•c nh·∫≠n</button>
        </div>
    </div>
</section>

<section class="card">
    <h2>T·∫°o ·ª©ng d·ª•ng m·ªõi</h2>
    <form id="appForm" class="grid" style="gap:0.75rem;">
        <div class="grid" style="gap:0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="appKey">App Key *</label>
                <input id="appKey" type="text" required maxlength="100" placeholder="vd: gotyfi" />
            </div>
            <div>
                <label for="displayName">T√™n hi·ªÉn th·ªã *</label>
                <input id="displayName" type="text" required maxlength="150" placeholder="GoTyfi" />
            </div>
        </div>
        <div>
            <label for="appDescription">M√¥ t·∫£</label>
            <input id="appDescription" type="text" maxlength="500" placeholder="Ghi ch√∫ n·ªôi b·ªô (tu·ª≥ ch·ªçn)" />
        </div>
        <div style="display:flex; gap:0.75rem; align-items:center;">
            <button type="submit">T·∫°o ·ª©ng d·ª•ng</button>
            <button type="button" id="btnClearAppForm" class="secondary">L√†m m·ªõi</button>
        </div>
        <p class="hint">App key ƒë∆∞·ª£c l∆∞u d·∫°ng ch·ªØ th∆∞·ªùng v√† ph·∫£i duy nh·∫•t. Sau khi t·∫°o th√†nh c√¥ng h√£y t·∫£i l·∫°i danh s√°ch ·ª©ng d·ª•ng.</p>
    </form>
</section>

<div class="grid grid-columns-2">
    <section class="card">
        <h2>·ª®ng d·ª•ng nh·∫≠n th√¥ng b√°o</h2>
        <div class="targets" id="targetList"></div>
        <button id="btnAddTarget" type="button" style="margin-top:0.75rem;">+ Th√™m ·ª©ng d·ª•ng nh·∫≠n</button>
        <p class="hint">M·ªói d√≤ng l√† m·ªôt m·ª•c ti√™u g·ª≠i. B·∫°n c√≥ th·ªÉ ch·ªçn App Version t∆∞∆°ng ·ª©ng ho·∫∑c ƒë·ªÉ tr·ªëng n·∫øu l√† th√¥ng b√°o th∆∞·ªùng.</p>
    </section>

    <section class="card">
        <h2>Danh s√°ch ·ª©ng d·ª•ng</h2>
        <ul id="appList" class="app-list"></ul>
    </section>
</div>

<div class="grid grid-columns-2">
    <section class="card">
        <h2>N·ªôi dung th√¥ng b√°o</h2>
        <form id="sendForm" class="grid" style="gap:0.85rem;">
            <div>
                <label for="title">Ti√™u ƒë·ªÅ *</label>
                <input id="title" type="text" required maxlength="100" placeholder="V√≠ d·ª•: üöÄ C·∫≠p nh·∫≠t 1.2.0" />
            </div>
            <div>
                <label for="body">N·ªôi dung *</label>
                <textarea id="body" required maxlength="4000" placeholder="M√¥ t·∫£ chi ti·∫øt"></textarea>
            </div>
            <div>
                <label for="link">Li√™n k·∫øt</label>
                <input id="link" type="url" placeholder="https://... (tu·ª≥ ch·ªçn)" />
            </div>
            <div>
                <label for="fileInput">ƒê√≠nh k√®m t·ªáp (tu·ª≥ ch·ªçn)</label>
                <input id="fileInput" type="file" />
                <p id="fileInfo" class="hint"></p>
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center;">
                <button type="submit" id="sendBtn">G·ª≠i th√¥ng b√°o</button>
                <button type="button" class="secondary" id="resetBtn">Xo√° n·ªôi dung</button>
            </div>
        </form>
    </section>

    <section class="card">
        <div class="grid" style="gap:0.75rem;">
            <div>
                <label for="versionAppSelect">Xem b·∫£n ph√°t h√†nh c·ªßa ·ª©ng d·ª•ng</label>
                <select id="versionAppSelect">
                    <option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>
                </select>
            </div>
            <ul id="versionList" class="version-list"></ul>
        </div>
    </section>
</div>

<section class="card">
    <h2>T·∫°o b·∫£n ph√°t h√†nh m·ªõi</h2>
    <form id="versionForm" class="grid" style="gap:0.75rem;">
        <div class="grid" style="gap:0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="versionAppKey">·ª®ng d·ª•ng *</label>
                <select id="versionAppKey" required>
                    <option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>
                </select>
            </div>
            <div>
                <label for="versionName">T√™n phi√™n b·∫£n *</label>
                <input id="versionName" type="text" required maxlength="50" placeholder="vd: 1.3.0" />
            </div>
        </div>
        <div class="grid" style="gap:0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
            <div>
                <label for="versionPlatform">N·ªÅn t·∫£ng</label>
                <input id="versionPlatform" type="text" maxlength="30" placeholder="android / ios / desktop" />
            </div>
            <div>
                <label for="versionReleaseDate">Ng√†y ph√°t h√†nh *</label>
                <input id="versionReleaseDate" type="datetime-local" required />
            </div>
        </div>
        <div>
            <label for="versionFileUrl">ƒê∆∞·ªùng d·∫´n t·∫£i *</label>
            <input id="versionFileUrl" type="url" required maxlength="255" placeholder="https://cdn.example.com/app/v1.3.0.apk" />
        </div>
        <div>
            <label for="versionChecksum">Checksum (SHA-256)</label>
            <input id="versionChecksum" type="text" maxlength="128" placeholder="Tu·ª≥ ch·ªçn" />
        </div>
        <div>
            <label for="versionNotes">Ghi ch√∫ ph√°t h√†nh</label>
            <textarea id="versionNotes" maxlength="4000" placeholder="Thay ƒë·ªïi, t√≠nh nƒÉng, h∆∞·ªõng d·∫´n..."></textarea>
        </div>
        <div style="display:flex; gap:0.75rem; align-items:center;">
            <button type="submit">L∆∞u b·∫£n ph√°t h√†nh</button>
            <button type="button" id="versionFormReset" class="secondary">L√†m m·ªõi</button>
        </div>
        <p class="hint">Sau khi l∆∞u, phi√™n b·∫£n m·ªõi s·∫Ω xu·∫•t hi·ªán trong danh s√°ch v√† dropdown g·∫Øn b·∫£n c·∫≠p nh·∫≠t c·ªßa khu v·ª±c g·ª≠i th√¥ng b√°o.</p>
    </form>
</section>

<section class="card">
    <h2>K·∫øt qu·∫£ / Log</h2>
    <pre id="status" class="status">Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.</pre>
</section>

<script>
const state = {
    baseUrl: '',
    apps: [],
    versions: new Map(),
    file: null
};

const apiBaseInput = document.getElementById('apiBase');
const btnLoadApps = document.getElementById('btnLoadApps');
const btnResetTargets = document.getElementById('btnResetTargets');
const appList = document.getElementById('appList');
const versionAppSelect = document.getElementById('versionAppSelect');
const versionList = document.getElementById('versionList');
const targetList = document.getElementById('targetList');
const btnAddTarget = document.getElementById('btnAddTarget');
const appForm = document.getElementById('appForm');
const btnClearAppForm = document.getElementById('btnClearAppForm');
const versionForm = document.getElementById('versionForm');
const versionFormReset = document.getElementById('versionFormReset');
const versionAppKeySelect = document.getElementById('versionAppKey');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const sendForm = document.getElementById('sendForm');
const resetBtn = document.getElementById('resetBtn');
const statusEl = document.getElementById('status');

function normalizeBaseUrl(value) {
    return value ? value.replace(/\/$/, '') : '';
}

function updateStatus(message, data) {
    const text = [message, data ? JSON.stringify(data, null, 2) : null]
        .filter(Boolean)
        .join('\n');
    statusEl.textContent = text || 'Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.';
}

async function fetchJson(path, options) {
    if (!state.baseUrl) throw new Error('Ch∆∞a thi·∫øt l·∫≠p m√°y ch·ªß API.');
    const response = await fetch(`${state.baseUrl}${path}`, options);
    const text = await response.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = text; }
    if (!response.ok) {
        throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
    }
    return data;
}

function renderApps() {
    state.versions.clear();
    appList.innerHTML = '';
    versionAppSelect.innerHTML = '<option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>';
    versionAppKeySelect.innerHTML = '<option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>';

    if (state.apps.length === 0) {
        appList.innerHTML = '<li>Ch∆∞a c√≥ ·ª©ng d·ª•ng. H√£y t·∫°o app m·ªõi ho·∫∑c t·∫£i l·∫°i danh s√°ch.</li>';
        return;
    }

    state.apps.forEach(app => {
        const li = document.createElement('li');
        li.innerHTML = `
            <strong>${app.displayName}</strong> <code>${app.appKey}</code><br/>
            <small>T·∫°o ng√†y: ${new Date(app.createdAt).toLocaleString()} ‚Äî ${app.versionCount} b·∫£n ph√°t h√†nh, ${app.notificationCount} th√¥ng b√°o</small>
            ${app.description ? `<div class="hint">${app.description}</div>` : ''}
        `;
        appList.appendChild(li);

        const option = document.createElement('option');
        option.value = app.appKey;
        option.textContent = `${app.displayName} (${app.appKey})`;
        versionAppSelect.appendChild(option);

        const formOption = option.cloneNode(true);
        versionAppKeySelect.appendChild(formOption);
    });

    syncTargetAppOptions();
}

function syncTargetAppOptions() {
    const appOptions = state.apps
        .map(app => `<option value="${app.appKey}">${app.displayName} (${app.appKey})</option>`)
        .join('');

    targetList.querySelectorAll('select[data-role="app"]').forEach(select => {
        const current = select.value;
        select.innerHTML = '<option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>' + appOptions;
        if (current) {
            select.value = current;
        }
    });
}

function addTargetRow(defaultKey = '') {
    const row = document.createElement('div');
    row.className = 'target-row';
    row.innerHTML = `
        <div>
            <label>·ª®ng d·ª•ng *</label>
            <select data-role="app">
                <option value="">-- Ch·ªçn ·ª©ng d·ª•ng --</option>
            </select>
        </div>
        <div>
            <label>B·∫£n ph√°t h√†nh</label>
            <select data-role="version">
                <option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>
            </select>
        </div>
        <button type="button" class="secondary" data-role="remove">Xo√°</button>
    `;

    targetList.appendChild(row);
    syncTargetAppOptions();
    const appSelect = row.querySelector('select[data-role="app"]');
    const versionSelect = row.querySelector('select[data-role="version"]');

    appSelect.addEventListener('change', async () => {
        const key = appSelect.value;
        await populateVersionSelect(versionSelect, key);
    });

    row.querySelector('button[data-role="remove"]').addEventListener('click', () => {
        row.remove();
    });

    if (defaultKey) {
        appSelect.value = defaultKey;
        appSelect.dispatchEvent(new Event('change'));
    }
}

async function populateVersionSelect(select, appKey) {
    select.innerHTML = '<option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>';
    if (!appKey) return;

    const versions = await ensureVersions(appKey);
    versions.forEach(ver => {
        const option = document.createElement('option');
        const date = new Date(ver.releaseDate).toLocaleString();
        option.value = ver.appVersionId;
        option.textContent = `${ver.versionName} ‚Äî ${date}`;
        select.appendChild(option);
    });
}

async function ensureVersions(appKey) {
    if (!appKey) return [];
    if (!state.versions.has(appKey)) {
        const data = await fetchJson(`/api/control/app-versions?appKey=${encodeURIComponent(appKey)}`);
        state.versions.set(appKey, Array.isArray(data) ? data : []);
    }
    return state.versions.get(appKey) ?? [];
}

async function refreshVersionPanel(appKey) {
    versionList.innerHTML = '';
    if (!appKey) {
        versionList.innerHTML = '<li>Ch·ªçn ·ª©ng d·ª•ng ƒë·ªÉ xem c√°c b·∫£n ph√°t h√†nh.</li>';
        return;
    }

    try {
        const versions = await ensureVersions(appKey);
        if (versions.length === 0) {
            versionList.innerHTML = '<li>·ª®ng d·ª•ng ch∆∞a c√≥ b·∫£n ph√°t h√†nh n√†o.</li>';
            return;
        }
        versions.forEach(ver => {
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${ver.versionName}</strong> ‚Äî ${ver.platform ?? 'N/A'}<br/>
                <small>${new Date(ver.releaseDate).toLocaleString()}</small><br/>
                ${ver.releaseNotes ? ver.releaseNotes : 'Kh√¥ng c√≥ ghi ch√∫.'}<br/>
                <a href="${ver.fileUrl}" target="_blank" rel="noopener">${ver.fileUrl}</a>
            `;
            versionList.appendChild(li);
        });
    } catch (err) {
        versionList.innerHTML = `<li style="color:#dc2626;">Kh√¥ng t·∫£i ƒë∆∞·ª£c b·∫£n ph√°t h√†nh: ${err.message}</li>`;
    }
}

btnLoadApps.addEventListener('click', async () => {
    state.baseUrl = normalizeBaseUrl(apiBaseInput.value.trim());
    if (!state.baseUrl) {
        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ m√°y ch·ªß API.');
        return;
    }
    try {
        btnLoadApps.disabled = true;
        updateStatus('ƒêang t·∫£i danh s√°ch ·ª©ng d·ª•ng...');
        const data = await fetchJson('/api/control/applications');
        state.apps = Array.isArray(data) ? data : [];
        renderApps();
        updateStatus('ƒê√£ t·∫£i danh s√°ch ·ª©ng d·ª•ng.', state.apps);
    } catch (err) {
        updateStatus('L·ªói t·∫£i ·ª©ng d·ª•ng:', err.message);
    } finally {
        btnLoadApps.disabled = false;
    }
});

versionAppSelect.addEventListener('change', () => {
    refreshVersionPanel(versionAppSelect.value);
});

btnAddTarget.addEventListener('click', () => {
    if (state.apps.length === 0) {
        alert('H√£y t·∫£i ho·∫∑c t·∫°o ·ª©ng d·ª•ng tr∆∞·ªõc.');
        return;
    }
    addTargetRow();
});

btnResetTargets.addEventListener('click', () => {
    targetList.innerHTML = '';
    state.versions.clear();
    versionList.innerHTML = '<li>Ch·ªçn ·ª©ng d·ª•ng ƒë·ªÉ xem b·∫£n ph√°t h√†nh.</li>';
});

appForm.addEventListener('submit', async evt => {
    evt.preventDefault();
    state.baseUrl = normalizeBaseUrl(apiBaseInput.value.trim());
    if (!state.baseUrl) {
        alert('Ch∆∞a c·∫•u h√¨nh m√°y ch·ªß API.');
        return;
    }

    const payload = {
        appKey: document.getElementById('appKey').value.trim(),
        displayName: document.getElementById('displayName').value.trim(),
        description: document.getElementById('appDescription').value.trim() || null
    };

    try {
        updateStatus('ƒêang t·∫°o ·ª©ng d·ª•ng...', payload);
        await fetchJson('/api/control/applications', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        updateStatus('T·∫°o ·ª©ng d·ª•ng th√†nh c√¥ng. H√£y t·∫£i l·∫°i danh s√°ch ƒë·ªÉ s·ª≠ d·ª•ng.');
        appForm.reset();
    } catch (err) {
        updateStatus('T·∫°o ·ª©ng d·ª•ng th·∫•t b·∫°i:', err.message);
    }
});

btnClearAppForm.addEventListener('click', () => {
    appForm.reset();
});

versionForm.addEventListener('submit', async evt => {
    evt.preventDefault();
    state.baseUrl = normalizeBaseUrl(apiBaseInput.value.trim());
    if (!state.baseUrl) {
        alert('Ch∆∞a c·∫•u h√¨nh m√°y ch·ªß API.');
        return;
    }

    const appKey = versionAppKeySelect.value;
    if (!appKey) {
        alert('H√£y ch·ªçn ·ª©ng d·ª•ng ƒë·ªÉ g·∫Øn b·∫£n ph√°t h√†nh.');
        return;
    }

    const releaseDateRaw = document.getElementById('versionReleaseDate').value;
    if (!releaseDateRaw) {
        alert('Vui l√≤ng ch·ªçn ng√†y ph√°t h√†nh.');
        return;
    }

    const releaseDate = new Date(releaseDateRaw);
    if (Number.isNaN(releaseDate.getTime())) {
        alert('Ng√†y ph√°t h√†nh kh√¥ng h·ª£p l·ªá.');
        return;
    }

    const payload = {
        appKey,
        versionName: document.getElementById('versionName').value.trim(),
        platform: document.getElementById('versionPlatform').value.trim() || null,
        fileUrl: document.getElementById('versionFileUrl').value.trim(),
        fileChecksum: document.getElementById('versionChecksum').value.trim() || null,
        releaseNotes: document.getElementById('versionNotes').value.trim() || null,
        releaseDate: releaseDate.toISOString()
    };

    try {
        updateStatus('ƒêang l∆∞u b·∫£n ph√°t h√†nh...', payload);
        const data = await fetchJson('/api/control/app-versions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        updateStatus('ƒê√£ t·∫°o b·∫£n ph√°t h√†nh.', data);
        versionForm.reset();
        const releaseInput = document.getElementById('versionReleaseDate');
        if (releaseInput) {
            releaseInput.value = '';
        }
        state.versions.delete(appKey);
        if (versionAppSelect.value === appKey) {
            refreshVersionPanel(appKey);
        }
        targetList.querySelectorAll('.target-row').forEach(row => {
            const select = row.querySelector('select[data-role="app"]');
            const versionSelect = row.querySelector('select[data-role="version"]');
            if (select.value === appKey) {
                populateVersionSelect(versionSelect, appKey);
            }
        });
    } catch (err) {
        updateStatus('T·∫°o b·∫£n ph√°t h√†nh th·∫•t b·∫°i:', err.message);
    }
});

versionFormReset.addEventListener('click', () => {
    versionForm.reset();
    const releaseInput = document.getElementById('versionReleaseDate');
    if (releaseInput) {
        releaseInput.value = '';
    }
});

fileInput.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    if (!file) {
        state.file = null;
        fileInfo.textContent = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        state.file = { base64, name: file.name, size: file.size };
        fileInfo.textContent = `ƒê√£ ch·ªçn ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    };
    reader.onerror = () => {
        state.file = null;
        fileInfo.textContent = 'Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp v·ª´a ch·ªçn.';
    };
    reader.readAsDataURL(file);
});

sendForm.addEventListener('submit', async evt => {
    evt.preventDefault();
    if (!state.baseUrl) {
        alert('Ch∆∞a c·∫•u h√¨nh m√°y ch·ªß API.');
        return;
    }

    const targets = Array.from(targetList.querySelectorAll('.target-row')).map(row => {
        const appKey = row.querySelector('select[data-role="app"]').value;
        const versionValue = row.querySelector('select[data-role="version"]').value;
        return {
            appKey,
            appVersionId: versionValue ? Number(versionValue) : null
        };
    }).filter(t => t.appKey);

    if (targets.length === 0) {
        alert('C·∫ßn th√™m √≠t nh·∫•t m·ªôt ·ª©ng d·ª•ng nh·∫≠n th√¥ng b√°o.');
        return;
    }

    const payload = {
        title: document.getElementById('title').value.trim(),
        body: document.getElementById('body').value.trim(),
        link: document.getElementById('link').value.trim() || null,
        targets,
        fileBase64: state.file ? state.file.base64 : null,
        fileName: state.file ? state.file.name : null
    };

    try {
        updateStatus('ƒêang g·ª≠i th√¥ng b√°o...', payload);
        const data = await fetchJson('/api/control/send-notification-json', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        updateStatus('G·ª≠i th√†nh c√¥ng:', data);
        sendForm.reset();
        fileInfo.textContent = '';
        state.file = null;
    } catch (err) {
        updateStatus('G·ª≠i th·∫•t b·∫°i:', err.message);
    }
});

resetBtn.addEventListener('click', () => {
    sendForm.reset();
    state.file = null;
    fileInfo.textContent = '';
    updateStatus('ƒê√£ xo√° n·ªôi dung th√¥ng b√°o.');
});

// Kh·ªüi t·∫°o m·∫∑c ƒë·ªãnh
versionList.innerHTML = '<li>Ch·ªçn ·ª©ng d·ª•ng ƒë·ªÉ xem b·∫£n ph√°t h√†nh.</li>';
updateStatus('Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.');
</script>
</body>
</html>
