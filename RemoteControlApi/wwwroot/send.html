<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>G·ª≠i th√¥ng b√°o</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
            font-family: "Inter", system-ui, sans-serif;
        }
        body {
            margin: 0;
            padding: 1.5rem;
            background: #f5f7fb;
            color: #1f2937;
        }
        header {
            margin-bottom: 1.5rem;
        }
        h1 {
            margin: 0 0 0.5rem;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 12px 32px rgba(15, 32, 75, 0.12);
            margin-bottom: 1.25rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
        }
        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            border: 1px solid #cbd2d9;
            border-radius: 8px;
            padding: 0.55rem 0.75rem;
            font-size: 0.95rem;
            box-sizing: border-box;
        }
        textarea {
            min-height: 140px;
            resize: vertical;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.65rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
        }
        button.secondary {
            background: transparent;
            color: #1d4ed8;
            border: 1px solid #c7d2fe;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .grid {
            display: grid;
            gap: 1rem;
        }
        @media (min-width: 960px) {
            .grid-columns-2 {
                grid-template-columns: 3fr 2fr;
            }
        }
        .status {
            font-size: 0.9rem;
            white-space: pre-wrap;
            background: #0f172a;
            color: #e0f2fe;
            padding: 1rem;
            border-radius: 8px;
            min-height: 140px;
        }
        .hint {
            font-size: 0.9rem;
            color: #4b5563;
        }
        ul.version-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 0.5rem;
        }
        ul.version-list li {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            background: #f9fafb;
        }
    </style>
</head>
<body>
<header>
    <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn g·ª≠i th√¥ng b√°o</h1>
    <p class="hint">Nh·∫≠p n·ªôi dung v√† ch·ªçn b·∫£n c·∫≠p nh·∫≠t (n·∫øu c√≥) ƒë·ªÉ g·ª≠i t·ªõi to√†n b·ªô ng∆∞·ªùi d√πng.</p>
</header>

<section class="card">
    <label for="apiBase">M√°y ch·ªß API</label>
    <div class="grid" style="grid-template-columns: minmax(0,1fr) auto; gap: 0.75rem; align-items: end;">
        <input id="apiBase" type="url" placeholder="https://example.com" />
        <button id="btnLoadVersions">T·∫£i b·∫£n ph√°t h√†nh</button>
    </div>
    <p class="hint" style="margin-top:0.5rem;">D√πng ƒë·ªÉ g·ªçi c√°c endpoint nh∆∞ <code>/api/control/app-versions</code>.</p>
</section>

<div class="grid grid-columns-2">
    <section class="card">
        <h2>N·ªôi dung th√¥ng b√°o</h2>
        <form id="sendForm" class="grid" style="gap: 0.85rem;">
            <div>
                <label for="title">Ti√™u ƒë·ªÅ *</label>
                <input id="title" type="text" required maxlength="100" placeholder="V√≠ d·ª•: üöÄ C·∫≠p nh·∫≠t 1.2.0" />
            </div>
            <div>
                <label for="body">N·ªôi dung *</label>
                <textarea id="body" required maxlength="4000" placeholder="M√¥ t·∫£ chi ti·∫øt"></textarea>
            </div>
            <div>
                <label for="link">Li√™n k·∫øt chuy·ªÉn h∆∞·ªõng</label>
                <input id="link" type="url" placeholder="https://... (tu·ª≥ ch·ªçn)" />
            </div>
            <div>
                <label for="versionSelect">G·∫Øn b·∫£n c·∫≠p nh·∫≠t</label>
                <select id="versionSelect">
                    <option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>
                </select>
                <p class="hint">B·∫•m "T·∫£i b·∫£n ph√°t h√†nh" ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch.</p>
            </div>
            <div>
                <label for="fileInput">ƒê√≠nh k√®m t·ªáp (tu·ª≥ ch·ªçn)</label>
                <input id="fileInput" type="file" />
                <p id="fileInfo" class="hint"></p>
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center;">
                <button type="submit" id="sendBtn">G·ª≠i th√¥ng b√°o</button>
                <button type="button" class="secondary" id="resetBtn">L√†m m·ªõi form</button>
            </div>
        </form>
    </section>

    <section class="card">
        <h2>B·∫£n ph√°t h√†nh m·ªõi nh·∫•t</h2>
        <ul id="versionList" class="version-list"></ul>
    </section>
</div>

<section class="card">
    <h2>K·∫øt qu·∫£ / Log</h2>
    <pre id="status" class="status">Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.</pre>
</section>

<script>
const state = {
    baseUrl: '',
    versions: [],
    file: null
};

const apiBaseInput = document.getElementById('apiBase');
const btnLoadVersions = document.getElementById('btnLoadVersions');
const versionSelect = document.getElementById('versionSelect');
const versionList = document.getElementById('versionList');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const statusEl = document.getElementById('status');
const form = document.getElementById('sendForm');
const resetBtn = document.getElementById('resetBtn');

function normalizeBaseUrl(value) {
    if (!value) return '';
    return value.replace(/\/$/, '');
}

function updateStatus(message, data) {
    const text = [message, data ? JSON.stringify(data, null, 2) : null]
        .filter(Boolean)
        .join('\n');
    statusEl.textContent = text || 'Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.';
}

async function fetchJson(path) {
    if (!state.baseUrl) throw new Error('Ch∆∞a thi·∫øt l·∫≠p m√°y ch·ªß API.');
    const response = await fetch(`${state.baseUrl}${path}`);
    if (!response.ok) {
        const text = await response.text();
        throw new Error(`${response.status} ${response.statusText}: ${text}`);
    }
    return response.json();
}

btnLoadVersions.addEventListener('click', async () => {
    state.baseUrl = normalizeBaseUrl(apiBaseInput.value.trim());
    if (!state.baseUrl) {
        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ m√°y ch·ªß API.');
        return;
    }
    try {
        btnLoadVersions.disabled = true;
        updateStatus('ƒêang t·∫£i b·∫£n ph√°t h√†nh...');
        const data = await fetchJson('/api/control/app-versions');
        state.versions = Array.isArray(data) ? data : [];
        renderVersions();
        updateStatus('ƒê√£ t·∫£i danh s√°ch b·∫£n ph√°t h√†nh.', state.versions);
    } catch (err) {
        updateStatus('L·ªói t·∫£i b·∫£n ph√°t h√†nh:', err.message);
    } finally {
        btnLoadVersions.disabled = false;
    }
});

function renderVersions() {
    versionSelect.innerHTML = '<option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>';
    versionList.innerHTML = '';

    if (state.versions.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'Ch∆∞a c√≥ b·∫£n ph√°t h√†nh. Th√™m d·ªØ li·ªáu b·∫±ng API /app-versions.';
        versionList.appendChild(li);
        return;
    }

    state.versions.forEach(ver => {
        const option = document.createElement('option');
        option.value = ver.appVersionId;
        const date = new Date(ver.releaseDate).toLocaleString();
        option.textContent = `${ver.versionName} ‚Äî ${date}`;
        versionSelect.appendChild(option);

        const item = document.createElement('li');
        item.innerHTML = `
            <strong>${ver.versionName}</strong><br/>
            <small>${date}</small><br/>
            ${ver.releaseNotes ? ver.releaseNotes : 'Kh√¥ng c√≥ ghi ch√∫.'}<br/>
            <a href="${ver.fileUrl}" target="_blank" rel="noopener">${ver.fileUrl}</a>
        `;
        versionList.appendChild(item);
    });
}

fileInput.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    if (!file) {
        state.file = null;
        fileInfo.textContent = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        state.file = { base64, name: file.name, size: file.size };
        fileInfo.textContent = `ƒê√£ ch·ªçn ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    };
    reader.onerror = () => {
        state.file = null;
        fileInfo.textContent = 'Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp v·ª´a ch·ªçn.';
    };
    reader.readAsDataURL(file);
});

form.addEventListener('submit', async evt => {
    evt.preventDefault();
    if (!state.baseUrl) {
        alert('Ch∆∞a c·∫•u h√¨nh m√°y ch·ªß API.');
        return;
    }

    const payload = {
        title: document.getElementById('title').value.trim(),
        body: document.getElementById('body').value.trim(),
        link: document.getElementById('link').value.trim() || null,
        appVersionId: versionSelect.value ? Number(versionSelect.value) : null,
        fileBase64: state.file ? state.file.base64 : null,
        fileName: state.file ? state.file.name : null
    };

    try {
        updateStatus('ƒêang g·ª≠i th√¥ng b√°o...', payload);
        const response = await fetch(`${state.baseUrl}/api/control/send-notification-json`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const text = await response.text();
        let data = text;
        try { data = JSON.parse(text); } catch {}
        if (!response.ok) {
            throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
        }
        updateStatus('G·ª≠i th√†nh c√¥ng:', data);
        form.reset();
        fileInfo.textContent = '';
        state.file = null;
    } catch (err) {
        updateStatus('G·ª≠i th·∫•t b·∫°i:', err.message);
    }
});

resetBtn.addEventListener('click', () => {
    form.reset();
    state.file = null;
    fileInfo.textContent = '';
    updateStatus('ƒê√£ ƒë·∫∑t l·∫°i form.');
});
</script>
</body>
</html>
