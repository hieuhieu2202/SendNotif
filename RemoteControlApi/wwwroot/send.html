<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>G·ª≠i th√¥ng b√°o ƒëa ·ª©ng d·ª•ng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
            font-family: "Segoe UI", system-ui, sans-serif;
        }
        body {
            margin: 0;
            padding: 0 1rem 2rem;
            background: #f5f7fb;
            color: #1f2933;
        }
        header {
            padding: 1.5rem 0 1rem;
        }
        h1 {
            margin: 0 0 0.5rem;
            font-size: 1.8rem;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 12px 30px rgba(15, 32, 75, 0.12);
            margin-bottom: 1.25rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
        }
        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            border: 1px solid #cbd2d9;
            border-radius: 8px;
            padding: 0.55rem 0.75rem;
            font-size: 0.95rem;
            box-sizing: border-box;
        }
        textarea {
            min-height: 140px;
            resize: vertical;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.65rem 1.2rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #fff;
        }
        button.secondary {
            background: transparent;
            color: #1d4ed8;
            border: 1px solid #d1d5db;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .grid {
            display: grid;
            gap: 1rem;
        }
        @media (min-width: 960px) {
            .grid-columns-2 {
                grid-template-columns: 2fr 3fr;
            }
        }
        .apps-list {
            display: grid;
            gap: 0.5rem;
        }
        .app-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .status {
            font-size: 0.9rem;
            white-space: pre-wrap;
            background: #0f172a;
            color: #e0f2fe;
            padding: 1rem;
            border-radius: 8px;
            min-height: 120px;
        }
        .hint {
            font-size: 0.9rem;
            color: #4b5563;
        }
    </style>
</head>
<body>
<header>
    <h1>B·∫£ng ƒëi·ªÅu khi·ªÉn g·ª≠i th√¥ng b√°o</h1>
    <p class="hint">Ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu ·ª©ng d·ª•ng ƒë·ªÉ g·ª≠i. Khi ch·ªâ ch·ªçn 1 ·ª©ng d·ª•ng, b·∫°n c√≥ th·ªÉ g·∫Øn th√¥ng b√°o v·ªõi m·ªôt b·∫£n c·∫≠p nh·∫≠t c·ª• th·ªÉ.</p>
</header>

<section class="card">
    <label for="apiBase">M√°y ch·ªß API</label>
    <div class="grid" style="grid-template-columns: minmax(0,1fr) auto; gap: 0.75rem; align-items: end;">
        <input id="apiBase" type="url" placeholder="https://example.com" />
        <button id="loadApps">T·∫£i danh s√°ch ·ª©ng d·ª•ng</button>
    </div>
    <p class="hint" style="margin-top:0.5rem;">ƒê∆∞·ªùng d·∫´n c∆° s·ªü ƒë∆∞·ª£c gh√©p v·ªõi c√°c endpoint nh∆∞ <code>/api/control/applications</code>.</p>
</section>

<div class="grid grid-columns-2">
    <section class="card">
        <h2>·ª®ng d·ª•ng nh·∫≠n th√¥ng b√°o</h2>
        <div id="appsContainer" class="apps-list"></div>
        <p id="appsHint" class="hint">Ch∆∞a c√≥ d·ªØ li·ªáu. B·∫•m "T·∫£i danh s√°ch ·ª©ng d·ª•ng" ho·∫∑c th√™m ·ª©ng d·ª•ng m·ªõi qua API.</p>
    </section>

    <section class="card">
        <h2>N·ªôi dung th√¥ng b√°o</h2>
        <form id="sendForm" class="grid" style="gap: 0.85rem;">
            <div>
                <label for="title">Ti√™u ƒë·ªÅ *</label>
                <input id="title" type="text" required maxlength="120" placeholder="V√≠ d·ª•: üöÄ C·∫≠p nh·∫≠t m·ªõi" />
            </div>
            <div>
                <label for="body">N·ªôi dung *</label>
                <textarea id="body" required maxlength="4000" placeholder="M√¥ t·∫£ chi ti·∫øt"></textarea>
            </div>
            <div>
                <label for="link">Li√™n k·∫øt chuy·ªÉn h∆∞·ªõng</label>
                <input id="link" type="url" placeholder="https://... (tu·ª≥ ch·ªçn)" />
            </div>
            <div>
                <label for="versionSelect">G·∫Øn b·∫£n c·∫≠p nh·∫≠t</label>
                <select id="versionSelect" disabled>
                    <option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>
                </select>
                <p class="hint">Ch·ªâ kh·∫£ d·ª•ng khi ch·ªçn ƒë√∫ng 1 ·ª©ng d·ª•ng.</p>
            </div>
            <div>
                <label for="fileInput">ƒê√≠nh k√®m t·ªáp (tu·ª≥ ch·ªçn)</label>
                <input id="fileInput" type="file" />
                <p id="fileInfo" class="hint"></p>
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center;">
                <button type="submit" id="sendBtn">G·ª≠i th√¥ng b√°o</button>
                <button type="button" class="secondary" id="resetBtn">L√†m m·ªõi form</button>
            </div>
        </form>
    </section>
</div>

<section class="card">
    <h2>K·∫øt qu·∫£ / Log</h2>
    <pre id="status" class="status">Ch∆∞a th·ª±c hi·ªán thao t√°c n√†o.</pre>
</section>

<script>
const state = {
    baseUrl: '',
    apps: [],
    selected: new Set(),
    versions: [],
    file: null
};

const apiBaseInput = document.getElementById('apiBase');
const loadAppsBtn = document.getElementById('loadApps');
const appsContainer = document.getElementById('appsContainer');
const appsHint = document.getElementById('appsHint');
const versionSelect = document.getElementById('versionSelect');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const statusEl = document.getElementById('status');
const form = document.getElementById('sendForm');
const resetBtn = document.getElementById('resetBtn');

function normalizeBaseUrl(value) {
    if (!value) return '';
    return value.replace(/\/$/, '');
}

function updateStatus(message, data) {
    const text = [message, data ? JSON.stringify(data, null, 2) : null]
        .filter(Boolean)
        .join('\n');
    statusEl.textContent = text;
}

async function fetchJson(path) {
    if (!state.baseUrl) throw new Error('Ch∆∞a thi·∫øt l·∫≠p m√°y ch·ªß API.');
    const response = await fetch(`${state.baseUrl}${path}`);
    if (!response.ok) {
        const text = await response.text();
        throw new Error(`${response.status} ${response.statusText}: ${text}`);
    }
    return response.json();
}

function renderApps() {
    appsContainer.innerHTML = '';
    if (state.apps.length === 0) {
        appsHint.style.display = 'block';
        return;
    }
    appsHint.style.display = 'none';
    state.apps.forEach(app => {
        const wrapper = document.createElement('label');
        wrapper.className = 'app-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = app.appKey;
        checkbox.checked = state.selected.has(app.appKey);
        checkbox.addEventListener('change', () => toggleApp(app.appKey, checkbox.checked));

        const info = document.createElement('div');
        info.innerHTML = `<strong>${app.displayName}</strong><br/><small>${app.appKey}</small>`;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(info);
        appsContainer.appendChild(wrapper);
    });
}

function toggleApp(appKey, isChecked) {
    if (isChecked) {
        state.selected.add(appKey);
    } else {
        state.selected.delete(appKey);
    }
    refreshVersionOptions();
}

async function refreshVersionOptions() {
    const selected = Array.from(state.selected);
    versionSelect.innerHTML = '<option value="">-- Kh√¥ng g·∫Øn b·∫£n c·∫≠p nh·∫≠t --</option>';
    versionSelect.disabled = selected.length !== 1;
    state.versions = [];

    if (selected.length === 1) {
        try {
            const data = await fetchJson(`/api/control/app-versions?appKey=${encodeURIComponent(selected[0])}`);
            state.versions = data;
            data.forEach(ver => {
                const option = document.createElement('option');
                option.value = ver.appVersionId;
                const platform = ver.platform ? ` [${ver.platform}]` : '';
                option.textContent = `${ver.versionName}${platform} ‚Äî ${new Date(ver.releaseDate).toLocaleString()}`;
                versionSelect.appendChild(option);
            });
        } catch (err) {
            updateStatus('Kh√¥ng th·ªÉ t·∫£i phi√™n b·∫£n:', err.message);
        }
    }
}

loadAppsBtn.addEventListener('click', async () => {
    state.baseUrl = normalizeBaseUrl(apiBaseInput.value.trim());
    if (!state.baseUrl) {
        alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ m√°y ch·ªß API.');
        return;
    }
    try {
        loadAppsBtn.disabled = true;
        updateStatus('ƒêang t·∫£i danh s√°ch ·ª©ng d·ª•ng...');
        const data = await fetchJson('/api/control/applications');
        state.apps = data;
        renderApps();
        updateStatus('T·∫£i ·ª©ng d·ª•ng th√†nh c√¥ng.', data);
    } catch (err) {
        updateStatus('L·ªói t·∫£i ·ª©ng d·ª•ng:', err.message);
    } finally {
        loadAppsBtn.disabled = false;
    }
});

fileInput.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    if (!file) {
        state.file = null;
        fileInfo.textContent = '';
        return;
    }
    const reader = new FileReader();
    reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        state.file = { base64, name: file.name, size: file.size };
        fileInfo.textContent = `ƒê√£ ch·ªçn ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    };
    reader.onerror = () => {
        state.file = null;
        fileInfo.textContent = 'Kh√¥ng th·ªÉ ƒë·ªçc t·ªáp v·ª´a ch·ªçn.';
    };
    reader.readAsDataURL(file);
});

form.addEventListener('submit', async evt => {
    evt.preventDefault();
    if (!state.baseUrl) {
        alert('Ch∆∞a c·∫•u h√¨nh m√°y ch·ªß API.');
        return;
    }
    const selected = Array.from(state.selected);
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·ª©ng d·ª•ng.');
        return;
    }

    const payload = {
        title: document.getElementById('title').value.trim(),
        body: document.getElementById('body').value.trim(),
        link: document.getElementById('link').value.trim() || null,
        fileBase64: state.file ? state.file.base64 : null,
        fileName: state.file ? state.file.name : null,
        targets: selected.map(appKey => ({
            appKey,
            appVersionId: null
        }))
    };

    if (selected.length === 1) {
        const ver = versionSelect.value;
        if (ver) {
            payload.targets[0].appVersionId = Number(ver);
        }
    }

    try {
        updateStatus('ƒêang g·ª≠i th√¥ng b√°o...', payload);
        const response = await fetch(`${state.baseUrl}/api/control/send-notification-json`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const text = await response.text();
        let data = text;
        try { data = JSON.parse(text); } catch {}
        if (!response.ok) {
            throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
        }
        updateStatus('G·ª≠i th√†nh c√¥ng:', data);
        form.reset();
        fileInfo.textContent = '';
        state.file = null;
    } catch (err) {
        updateStatus('G·ª≠i th·∫•t b·∫°i:', err.message);
    }
});

resetBtn.addEventListener('click', () => {
    form.reset();
    state.file = null;
    fileInfo.textContent = '';
    updateStatus('ƒê√£ ƒë·∫∑t l·∫°i form.');
});
</script>
</body>
</html>
