<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Giám sát thông báo ứng dụng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            color-scheme: light dark;
            font-family: "Inter", system-ui, sans-serif;
        }
        body {
            margin: 0;
            background: #f2f4f8;
            color: #111827;
            padding: 1.5rem;
        }
        header {
            margin-bottom: 1.5rem;
        }
        h1 {
            margin: 0;
            font-size: 1.9rem;
        }
        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 10px 24px rgba(15, 32, 75, 0.12);
            margin-bottom: 1.25rem;
        }
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 0.35rem;
        }
        input, select, button {
            font-size: 0.95rem;
        }
        input[type="text"],
        input[type="url"],
        select {
            width: 100%;
            padding: 0.55rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #cbd5f5;
            box-sizing: border-box;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
        }
        button.secondary {
            background: transparent;
            color: #059669;
            border: 1px solid #a7f3d0;
        }
        .grid {
            display: grid;
            gap: 1rem;
        }
        @media (min-width: 992px) {
            .grid-columns-2 {
                grid-template-columns: 3fr 2fr;
            }
        }
        .notif-list {
            display: grid;
            gap: 0.75rem;
        }
        .notif-item {
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 0.9rem 1rem;
            background: #fdfdfd;
        }
        .notif-item h3 {
            margin: 0 0 0.35rem;
            font-size: 1.05rem;
        }
        .notif-meta {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 0.35rem;
        }
        .notif-body {
            font-size: 0.95rem;
            white-space: pre-wrap;
        }
        .update-block {
            margin-top: 0.6rem;
            background: #ecfdf5;
            border-left: 4px solid #34d399;
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .status {
            background: #0b1120;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            min-height: 120px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
<header>
    <h1>Trung tâm nhận thông báo</h1>
    <p>Nhập địa chỉ máy chủ API để xem thông báo và kiểm tra phiên bản mới nhất.</p>
</header>

<section class="card">
    <div class="grid" style="gap:0.85rem;">
        <div>
            <label for="baseUrl">Máy chủ API</label>
            <input id="baseUrl" type="url" placeholder="https://example.com" />
        </div>
        <div style="display:flex; gap:0.75rem; align-items:flex-end;">
            <button id="btnLoad">Tải thông báo</button>
            <button id="btnRefresh" class="secondary">Làm mới</button>
        </div>
    </div>
</section>

<div class="grid grid-columns-2">
    <section class="card">
        <h2>Danh sách thông báo</h2>
        <div id="notifList" class="notif-list"></div>
    </section>
    <section class="card">
        <h2>Kiểm tra cập nhật ứng dụng</h2>
        <form id="versionForm" class="grid" style="gap:0.75rem;">
            <div>
                <label for="currentVersion">Phiên bản hiện tại *</label>
                <input id="currentVersion" type="text" placeholder="vd: 1.0.0" required />
            </div>
            <div style="display:flex; gap:0.75rem; align-items:center;">
                <button type="submit">Kiểm tra</button>
                <button type="button" id="clearStatus" class="secondary">Xoá log</button>
            </div>
        </form>
        <pre id="status" class="status">Chưa thực hiện kiểm tra.</pre>
    </section>
</div>

<script>
const state = {
    baseUrl: '',
    notifications: []
};

const baseUrlInput = document.getElementById('baseUrl');
const btnLoad = document.getElementById('btnLoad');
const btnRefresh = document.getElementById('btnRefresh');
const notifList = document.getElementById('notifList');
const versionForm = document.getElementById('versionForm');
const statusEl = document.getElementById('status');
const clearStatusBtn = document.getElementById('clearStatus');

function normalizeBaseUrl(value) {
    return value ? value.replace(/\/$/, '') : '';
}

function setStatus(text, data) {
    const content = [text, data ? JSON.stringify(data, null, 2) : null]
        .filter(Boolean)
        .join('\n');
    statusEl.textContent = content || 'Đang chờ thao tác.';
}

async function fetchJson(path) {
    if (!state.baseUrl) throw new Error('Chưa thiết lập API base URL');
    const res = await fetch(`${state.baseUrl}${path}`);
    if (!res.ok) {
        const txt = await res.text();
        throw new Error(`${res.status} ${res.statusText}: ${txt}`);
    }
    return res.json();
}

btnLoad.addEventListener('click', async () => {
    state.baseUrl = normalizeBaseUrl(baseUrlInput.value.trim());
    if (!state.baseUrl) {
        alert('Nhập địa chỉ máy chủ API trước.');
        return;
    }
    await loadNotifications();
});

btnRefresh.addEventListener('click', () => {
    if (!state.baseUrl) {
        alert('Chưa thiết lập máy chủ API.');
        return;
    }
    loadNotifications();
});

async function loadNotifications() {
    try {
        btnLoad.disabled = true;
        btnRefresh.disabled = true;
        notifList.innerHTML = '<p>Đang tải thông báo...</p>';
        const data = await fetchJson('/api/control/get-notifications?pageSize=50');
        state.notifications = data.items ?? [];
        renderNotifications();
    } catch (err) {
        notifList.innerHTML = `<p style="color:#dc2626;">Lỗi tải thông báo: ${err.message}</p>`;
    } finally {
        btnLoad.disabled = false;
        btnRefresh.disabled = false;
    }
}

function renderNotifications() {
    notifList.innerHTML = '';
    if (state.notifications.length === 0) {
        notifList.innerHTML = '<p>Chưa có thông báo nào.</p>';
        return;
    }
    state.notifications.forEach(item => {
        const div = document.createElement('div');
        div.className = 'notif-item';
        const created = new Date(item.createdAt).toLocaleString();
        const linkHtml = item.link ? `<a href="${item.link}" target="_blank" rel="noopener">${item.link}</a>` : 'Không có';
        div.innerHTML = `
            <h3>${item.title}</h3>
            <div class="notif-meta">${created}</div>
            <div class="notif-body">${item.message ?? ''}</div>
            <div class="notif-meta">Liên kết: ${linkHtml}</div>
        `;
        if (item.fileUrl) {
            const fileLink = document.createElement('div');
            fileLink.className = 'notif-meta';
            fileLink.innerHTML = `Tệp đính kèm: <a href="${item.fileUrl}" target="_blank" rel="noopener">${item.fileUrl}</a>`;
            div.appendChild(fileLink);
        }
        if (item.appVersion) {
            const block = document.createElement('div');
            block.className = 'update-block';
            block.innerHTML = `
                <strong>Bản cập nhật: ${item.appVersion.versionName}</strong><br/>
                ${item.appVersion.releaseNotes ?? 'Không có ghi chú.'}<br/>
                <a href="${item.appVersion.fileUrl}" target="_blank" rel="noopener">Tải gói cài đặt</a>
            `;
            div.appendChild(block);
        }
        notifList.appendChild(div);
    });
}

versionForm.addEventListener('submit', async evt => {
    evt.preventDefault();
    if (!state.baseUrl) {
        alert('Chưa thiết lập máy chủ API.');
        return;
    }
    const current = document.getElementById('currentVersion').value.trim();
    if (!current) {
        alert('Vui lòng nhập phiên bản hiện tại.');
        return;
    }
    try {
        setStatus('Đang kiểm tra cập nhật...');
        const data = await fetchJson(`/api/control/check-app-version?currentVersion=${encodeURIComponent(current)}`);
        setStatus('Kết quả kiểm tra:', data);
    } catch (err) {
        setStatus('Kiểm tra thất bại:', err.message);
    }
});

clearStatusBtn.addEventListener('click', () => {
    setStatus('Log đã được xoá.');
});
</script>
</body>
</html>
